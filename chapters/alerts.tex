% ########################################

\chapter{Processing Transient Alerts}
\label{chap:alerts}

% ~~~~~~~~~~~~~~~~~~~~

\chaptoc{}

% ########################################

\section{Introduction}
\label{sec:alerts_intro}

% ~~~~~~~~~~~~~~~~~~~~

\begin{colsection}

In this chapter I describe the software used by GOTO to process alerts generated from transient astronomical events, including gravitational-wave detections.
%
\begin{itemize}
    \item In \nref{sec:transient_alerts} I give an overview of the established systems through which the LVC, NASA and other organisations publish and distribute astronomical alerts.
    \item In \nref{sec:gotoalert} I describe the GOTO-alert Python package, and how transient alerts are received and processed.
    \item In \nref{sec:strategy} I describe how the optimal follow-up strategy is determined for different types of alert, and how the targets are defined for GOTO to observe.
\end{itemize}
%
All work described in this chapter is my own unless otherwise indicated, and has not been published elsewhere.

\end{colsection}

% ########################################

\section{Transient event alerts}
\label{sec:transient_alerts}

% ~~~~~~~~~~~~~~~~~~~~

\begin{colsection}

For the last few decades the number of detections of transient astronomical sources has been rapidly increasing. From space-based gamma-ray burst monitors such as \textit{Fermi} and \textit{Swift} to wide-field survey telescopes such as the \acro{ptf} and \acro{asassn}, increasing numbers of time-critical events have been detected and rapidly sent to other observing partners for follow-up campaigns. Historically this was done, at a much slower pace, through physical post and telegrams --- hence the names of some of the current services offering modern, email-based alternatives: the Astronomer's Telegram \citep{ATel} and the \acro{gcn} Circulars and Notices \citep{GCN}.

Today the global system has evolved to remove the human factor entirely, in order to reduce the delay between events being detected and follow-up observations being taken. Robotic telescopes are now common and can be triggered automatically by machine processing of alerts, which are themselves generated automatically by the detection instruments. The \acro{ivoa} VOEvent protocol \citep{voevent} has become the standard language for such robotic communications, allowing telescopes around the world to respond within seconds to transient detections. New projects such as the \acro{ztf}, itself paving the way for the forthcoming \acro{lsst}, will produce millions of events per night requiring even faster and more efficient alert systems \citep{ZTF_alerts}.

GOTO's priority is, of course, detecting optical counterparts to gravitational-wave events. Such events are published by the LIGO-Virgo Collaboration as VOEvents through the GCN Notice system.

\newpage

\end{colsection}

% ~~~~~~~~~~~~~~~~~~~~

\subsection{GCN alerts}
\label{sec:gcn}
\begin{colsection}

The Gamma-ray burst Coordinates Network, also known as the Transient Astronomy Network or together GCN/TAN, is a system hosted by NASA originally to publish alerts relating to gamma-ray burst detections \citep{GCN}. It publishes events from a variety of telescopes including \textit{INTEGRAL}, \textit{Fermi} and \textit{Swift}, and more recently has expanded to neutrino and gravitational-wave alerts --- including publishing alerts from the LIGO-Virgo Collaboration.

Alerts are produced by the various facilities in the form of GCN Notices, standard machine-readable text messages that are distributed by the network. Notices are designed to be written and sent out automatically by the facility without the need for human intervention, and likewise can be received and acted on by automated systems run by follow-up projects such as GOTO's sentinel (see \aref{sec:sentinel}). Transmitting notices is only done by the projects that are part of the network.

There is a second form of alerts distributed by the network called GCN Circulars. Unlike notices, circulars are intended to be written by humans and sent out by email to anyone subscribed to the distribution list. They act as a formal, citable way to share information about events, both the initial detection by the facility any any follow-up activity by other groups.

\end{colsection}

% ~~~~~~~~~~~~~~~~~~~~

\subsection{VOEvents}
\label{sec:voevents}
\begin{colsection}

The GCN/TAN system broadcasts notices in multiple ways over many different channels, but the most useful for automated telescopes such as GOTO uses the IVOA VOEvent standard \citep{voevent}. VOEvents are a standard way to transmit information about transient astronomical events, in a structured format to make the reports easily machine-readable. Each event is assigned an \acro{ivorn} and follows a defined schema. By defining a standard template to follow, diverse events can be automatically processed and robotic telescopes triggered without the need for human interpretation or vetting.

The structure to transmit these events is fairly flexible, but there are certain common roles. The names below are taken from \citet{voevent}:

\begin{itemize}
    \item \textbf{Authors} are the projects, facilities or institutions that create the original data worthy of reporting in the VOEvent.
    \item \textbf{Publishers} take the information about the astronomical event, put it into the VOEvent format and broadcast it from their servers.
    \item \textbf{Brokers} act as nodes in the communication web that can take in events from multiple publishers and rebroadcast them in a single stream.
    \item \textbf{Subscribers} are the end users that listen to VOEvent servers, either directly to the publishers or to a broker.
\end{itemize}

In some cases the above roles can be combined, but for the case of GOTO receiving gravitational-wave events there are distinct actors: the LIGO-Virgo Collaboration is the event's author, NASA and the GCN/TAN system are the publishers and the GOTO sentinel is the subscriber.

It is possible to listen directly to the GCN/TAN servers, in which case the sentinel would receive VOEvents from the NASA missions and other projects like LIGO.\@ However, there are other groups publishing their own VOEvents, separate to the GCN system, which we might want to receive. It would be possible to run multiple event listeners within the sentinel, each listening to a different server, but it is much easier to listen to a broker that already does that and provides a single point of access to these pipelines.

The broker listened to by the G-TeCS sentinel is the 4 Pi Sky VOEvents Hub \citep{4pisky}. 4 Pi Sky combines alerts from the GCN system\footnote{\url{https://gcn.gsfc.nasa.gov/burst_info.html}} as well as from the \textit{Gaia}\footnote{\url{http://gsaweb.ast.cam.ac.uk/alerts/alertsindex}} and ASAS-SN\footnote{\href{http://www.astronomy.ohio-state.edu/~assassin/transients}{\texttt{http://www.astronomy.ohio-state.edu/\raisebox{0.5ex}{\texttildelow}assassin/transients}}} projects. At the time of writing GOTO only follows up LVC gravitational-wave events and \textit{Fermi} and \textit{Swift} gamma-ray burst detections, all of which are published through GCNs, meaning there is technically no benefit of listening to 4 Pi Sky over listening directly to NASA.\@ However pt5m uses the 4 Pi Sky broker to receive and automatically follow up \textit{Gaia} transient detections, and it has been suggested GOTO could do the same in the future.

In order to receive VOEvents from any source it is necessary to set up a VOEvent client. The most common way to do this is using the Comet software \citep{comet}, which allows both sending and receiving of events. For the G-TeCS sentinel (see \aref{sec:sentinel}) all that was required was a simple way to listen to and download alerts, which is why it instead uses code based on the PyGCN Python package (\pkg{pygcn}\footnote{\url{https://github.com/lpsinger/pygcn}}). Despite the name, PyGCN can receive any VOEvents, not just those from the GCN servers. The sentinel uses PyGCN to open a socket to the 4 Pi Sky server and ingest binary packets, as well as sending the required receipt and ``\code{iamalive}'' responses to the server to ensure it keeps receiving events.

VOEvents take the form of a structured \acro{xml} document. XML is a ``markup'' language similar to HTML, JSON or \LaTeX, meaning it is understandable by humans but follows a set schema and so can be easily read and processed by computers. A sample of a VOEvent is given in \aref{fig:voevent_xml}.

\begin{figure}[p]
    \lstinputlisting[language=xml,
       tabsize=2,
       breaklines=true,
       keywordstyle={},
       stringstyle=\color{red},
       showstringspaces=false,
       basicstyle=\ttfamily\scriptsize,
       emph={voe,Who,What,WhereWhen,How,Citations},
       emphstyle={\color{magenta}},
       columns=fullflexible
       ]{images/voevent.xml}
    \caption[VOEvent XML sample]{
        A sample of VOEvent text from an LVC event, formatted so the core XML structure is visible. Some of the key pieces of information are the role and IVORN defined in the header, the skymap URL, and the event classification probabilities.
    }\label{fig:voevent_xml}
\end{figure}

\newpage

\end{colsection}

% ########################################

\section{Processing alerts}
\label{sec:gotoalert}

% ~~~~~~~~~~~~~~~~~~~~

\begin{colsection}

Once a VOEvent is received by the G-TeCS sentinel, the task of parsing and processing the event uses another Python package, GOTO-alert (\pkg{gotoalert}\footnote{\url{https://github.com/GOTO-OBS/goto-alert}}), which contains functions related to processing transient alerts. GOTO-alert was originally written by Alex Obradovic at Monash to listen for GRB alerts, when I took the code over I rewrote it to integrate it into G-TeCS, as well as adding the capability to process gravitational-wave alerts.

\end{colsection}

% ~~~~~~~~~~~~~~~~~~~~

\subsection{Event classes}
\label{sec:event_classes}
\begin{colsection}

\begin{table}[t]
    \begin{center}
        \begin{tabular}{clll}
            Packet type & Source              & Notice type                  & Event subclass           \\
            \midrule
            \code{61}   & NASA/\textit{Swift} & \code{SWIFT\_BAT\_GRB\_POS}  & \code{GRBEvent}          \\
            \code{115}  & NASA/\textit{Fermi} & \code{FERMI\_GBM\_FIN\_POS}  & \code{GRBEvent}          \\
            \code{150}  & LVC                 & \code{LVC\_PRELIMINARY}      & \code{GWEvent}           \\
            \code{151}  & LVC                 & \code{LVC\_INITIAL}          & \code{GWEvent}           \\
            \code{152}  & LVC                 & \code{LVC\_UPDATE}           & \code{GWEvent}           \\
            \code{164}  & LVC                 & \code{LVC\_RETRACTION}       & \code{GWRetractionEvent} \\
        \end{tabular}
    \end{center}
    \caption[GCN notices recognised by the GOTO-alert event handler]{
        GCN notices and corresponding classes recognised by the GOTO-alert event handler. The packet type is used by the GCN system to identify the class of event.
    }\label{tab:events}
\end{table}

At the core of the GOTO-alert code is the \code{Event} object class. Events are Python classes created from the raw VOEvent XML payload received by the PyGCN listener, containing the basic event information (IVORN, type, source etc). Once the basic Event is created it is checked against an internal list of so-called ``interesting'' event packet types --- the ones we care about processing for GOTO.\@ At the time of writing these are \code{SWIFT\_BAT}, \code{FERMI\_GBM} and \code{LVC} events, as listed in \aref{tab:events}. If the event matches any of the recognised packet types then the Event is subclassed into a new object, which allows more specific properties and methods. The current subclasses are as follows:

% ---------
\subsubsection{GRB Events}

The \code{GRBEvent} class is used for events relating to gamma-ray burst detections, specifically from \textit{Fermi} and \textit{Swift}. The VOEvents for these events contain a sky position in right ascension and declination as well as an error radius, so a HEALPix skymap is produced using the Gaussian method described in \aref{sec:grb_skymaps}. For \textit{Fermi} events the class also has an additional attribute extracted from the VOEvent: the duration of the burst (Long or Short).

% ---------
\subsubsection{GW Events}

The \code{GWEvent} class is used for LVC gravitational-wave events. LVC events have several stages: a ``Preliminary'' alert is released as soon as the signal is detected, then an ``Initial'' alert is issued once it has been human-vetted. From then on future versions are marked as ``Update'' alerts, unless the event itself is found to be non-physical or below certain thresholds in which case a ``Retraction'' alert is issued. As these are events produced by LIGO-Virgo they should contain a \code{skymap\_fits} parameter (as shown in \aref{fig:voevent_xml}), which gives a URL pointing to where the skymap can be downloaded from GraceDB, the LIGO event database\footnote{\url{https://gracedb.ligo.org}}. The gravitational-wave VOEvents also contain a variety of properties that are stored in the event class and which can be used to determine the observing strategy (see \aref{sec:event_strategy}) to use. These include:
\begin{itemize}
    \item \textbf{\acro{far}}: an estimate of the probability that this event is a false alarm, i.e.\ not from a real astronomical source. Given in the form of an expected frequency or rate, so an event with a false alarm rate of 1~per~year is much less significant than one with a FAR of 1~per~10,000 years.
    \item \textbf{Instruments}: which of the active gravitational-wave detectors (currently LIGO-Livingston, LIGO-Hanford and Virgo) detected the signal. A non-detection in one or more instruments is also accounted for in the false alarm rate.
    \item \textbf{Group}: which type of GW pipeline detected the event signal, either ``CBC'' (Compact Binary Coalescence)\acroadd{cbc} or ``Burst'' \citep[other, unmodelled detections, see][]{GW_burst}. The following parameters only apply to CBC events.
    \item \textbf{Classification}: the VOEvents for CBC events include probabilities that the source falls into one of five categories: \acro{bns} mergers, \acro{nsbh} mergers, \acro{bbh} mergers, ``MassGap'' mergers \citep[one or other of the components is in the hypothetical ``mass gap'' between neutron stars and black holes, defined as 3--\SI{5}{\solarmass};][]{GW_MassGap}, or ``Terrestrial'' (a non-astronomical source).
    \item \textbf{Properties}: CBC events also contain two important properties: ``HasNS'', the probability that the mass of one or both of the components is consistent with a neutron star ($<$\SI{3}{\solarmass}); and ``HasRemnant'', the probability that a non-zero amount of material was ejected during coalescence and therefore an electromagnetic signal might be expected \citep{LVC_userguide}.
    \item \textbf{Distance}: The skymaps produced by the LVC contain three-dimensional localisation information \citep{GW_distance}. For deciding on event strategy the mean distance, in megaparsec, is read from the skymap FITS header, along with the standard deviation.
\end{itemize}

% ---------
\subsubsection{GW Retraction Events}

\code{GWRetractionEvent} is a special event subclass used to handle LVC notices that are retractions of earlier events. They are effectively just a more limited version of the \code{GWEvent} class, as the retraction VOEvents do not contain a skymap or any of the additional parameters listed above. Having retraction events occupy their own subclass makes it easier to identify and process them when sent through the event handler.

\newpage

\end{colsection}

% ~~~~~~~~~~~~~~~~~~~~

\subsection{The event handler}
\label{sec:event_handler}
\begin{colsection}

Once the correct \code{Event} class has been created the sentinel passes it to the GOTO-alert \code{event\_handler} function. Before processing the event, the handler first filters out any unwanted events which do not come under any of the above subclasses. These are primarily alerts from other facilities (\textit{INTEGRAL}, \textit{Gaia} etc) or other event classes that are not ``interesting'' to GOTO (\textit{Fermi} releases several types of alerts, but only the final GBM positions are processed). If the event passed to the event handler is not marked as ``interesting'' then it is rejected at this stage and the handler exits. The handler will also intentionally reject an event that is ``interesting'' if it has an incorrect role. LVC sends out test VOEvents to allow full testing of any follow-up systems; these are identical to real events (even including simulated skymaps) but are explicitly marked with the role of \code{test} rather than \code{observation}. These can be optionally processed by the event handler, but in the live sentinel system they are rejected at this point.

If the event passes the above filter the next step is to download the event's skymap (for GW events, see \aref{sec:skymaps}) or create a corresponding Gaussian skymap (for GRB events, see \aref{sec:grb_skymaps}). Doing this after filtering-out uninteresting events saves time and space when downloading or creating skymaps that are not used, for example for LVC test events.

Once the event has a skymap the observing strategy for the event can be generated. This can only happen after the skymap is downloaded as some parameters, notably the distance for GW events, are only stored within the skymap headers instead of in the VOEvent XML.\@ The details of the different event strategies and how they are defined are given in \aref{sec:event_strategy}.

Finally, the event handler inserts pointings and other information into the observation database, with parameters depending on the strategy determined in the previous stage. This is detailed in \aref{sec:event_insert}.

\newpage

\end{colsection}

% ~~~~~~~~~~~~~~~~~~~~

\subsection{Event reports}
\label{sec:event_slack}
\begin{colsection}

Throughout the event handling process, GOTO-alert has the option of sending confirmation messages to Slack in a similar way to the G-TeCS pilot (see \aref{sec:slack}). This allows human observers to be informed of any new alerts processed by the sentinel, as well as the expected outcome of upcoming observations. Alerts are deliberately spaced out at different stages within the event handler, rather than all sent at the end, to make it obvious if a problem occurs and one or more alerts are missing.

Four alerts are sent out in total:
%
\begin{enumerate}
    \item An \textbf{initial} alert is sent out by the sentinel as soon as an interesting event is received, and contains only one line reporting the IVORN of the event to be processed. Sending this first means there is a record should an error subsequently occur.
    \item Next, the \textbf{event} alert is sent out by GOTO-alert once the event has been created and the skymap downloaded. It contains the key information and properties of the event, as well as a plot of the skymap produced by GOTO-tile.
    \item The \textbf{strategy} alert is sent out after the event observing strategy has been retrieved, and reports the contents of the strategy dictionaries (see \aref{sec:event_strategy}).
    \item Finally, the \textbf{visibility} alert is sent out after the event tiles have been added to the observation database (see \aref{sec:event_insert}). As well as showing the number of tiles selected and their combined skymap coverage, this alert also predicts which tiles will be visible from the GOTO site on La Palma over the valid observing period. This is only based on tile altitudes during the night, and excludes other factors (weather conditions, the position of the Moon, any higher-priority pointings that would take precedence) considered by the G-TeCS just-in-time scheduler (see \aref{sec:ranking}).
\end{enumerate}
%
An example of alerts generated for a gravitational-wave event are shown in \aref{fig:gotoalert_slack}.

\begin{sidewaysfigure}[p]
    \begin{center}
        \includegraphics[width=\linewidth]{images/slack_alert_side2.png}
    \end{center}
    \caption[Slack alerts created by GOTO-alert for a GW event]{
        Slack alerts generated by GOTO-alert for GW event S190426c \citep{S190426c}.
        The event alert (left) includes key information about the event gathered from the GCN notice. For GW events that includes FAR, classification and distance information, a link to the GraceDB page and a skymap generated by GOTO-tile.
        The strategy alert (centre) details the event observing strategy (see \aref{sec:event_strategy}).
        The visibility alert (right) reports how many tiles were inserted into the observation database and what skymap probability they cover. The attached plot shows a prediction of which tiles will be visible during the valid observing period.
    }\label{fig:gotoalert_slack}
\end{sidewaysfigure}

\end{colsection}

% ########################################

\section{Strategies for follow-up observations}
\label{sec:strategy}

% ~~~~~~~~~~~~~~~~~~~~

\begin{colsection}

An important function of the GOTO-alert event handler is to determine the specific strategy to be used for follow-up observations of each interesting event. Through the G-TeCS observation database (see \aref{sec:obsdb}), observations can be tailored to the properties of the triggering event, either by altering the validity, priority and cadence of the pointings inserted into the scheduler queue (see \aref{sec:ranking}) or by customising the commands issued by the pilot when each pointing is selected (see \aref{sec:pilot}).

The term \emph{strategy} is used deliberately to differentiate from the actions carried out by the on-site pilot, which are better called \emph{tactics}. Properly defined, strategy considers long-term aims and objectives (consider generals directing a war far from the front lines, or the coach of a sports team), whereas tactics are the on-the-ground implementation details used to move towards those objectives (determined by the captain in the trenches or on the pitch). The sentinel decides the observing strategy for a particular event, using the structures and functions within GOTO-alert. These decisions are then communicated to the pilot through the observation database, which decides what to do independently using the scheduler and the local conditions. Only then are commands sent to the hardware daemons to put the plan into action: like the soldiers on the battlefield or players on the pitch, theirs is not to reason why but to carry out their orders as issued.

The importance of such a distinction is that the strategies and objectives decided by the sentinel can only ever be aspirational, for the best-case scenario. It can decide a follow-up plan for an event, but if the location is not visible from La Palma, or it is currently raining, then the pilot will be unable to implement it. The sentinel is designed to be aspirational and not consider smaller details such as these in order to make it independent of physical hardware. Ultimately GOTO is envisioned to occupy multiple sites across the world, as described in \aref{sec:goto_expansion}, but the intention is that they will all still be taking orders from a single central sentinel and database (see \aref{sec:gtecs_future}).

\end{colsection}

% ~~~~~~~~~~~~~~~~~~~~

\subsection{Determining observation strategies for events}
\label{sec:event_strategy}
\begin{colsection}


\begin{figure}[t]
    \begin{center}
        \includegraphics[width=\linewidth]{images/strategy_flowchart.pdf}
    \end{center}
    \caption[Decision tree for determining event strategy]{
        Decision tree for determining event strategy.
    }\label{fig:strategy_flowchart}
\end{figure}

In order to decide the observation strategy for a given event, the GOTO-alert event handler uses the decision tree shown in \aref{fig:strategy_flowchart}. The codes at the end of the branches (\code{GW\_CLOSE\_NS}, \code{GRB\_FERMI}, etc) are the individual strategies, and they correspond to keys in the strategy dictionary defined within GOTO-alert as shown in \aref{tab:strategy_dict}. Each strategy corresponds to an integer rank as well as further keys relating to cadence, constraints and exposure sets which are keys in three additional dictionaries shown in \aref{tab:cadence_dict}, \aref{tab:constraints_dict} and \aref{tab:exposuresets_dict}.  Through this structure all the values required for inserting an event into the database are defined, and it is also simple to modify strategies or add in new ones. The reasoning behind each strategy is outlined below.

\clearpage

\begin{table}[!p]
    \begin{center}
        \begin{tabular}{lclll}
            Strategy & Rank & Cadence & Constraints & ExposureSets \\
            \midrule
            \code{GW\_CLOSE\_NS} &    2 & \code{NO\_DELAY}               & \code{LENIENT} & \code{3x60L} \\ % chktex 29
            \code{GW\_FAR\_NS}   &   13 & \code{NO\_DELAY}               & \code{LENIENT} & \code{3x60L} \\ % chktex 29
            \code{GW\_CLOSE\_BH} &   24 & \code{TWO\_NIGHTS}             & \code{LENIENT} & \code{3x60L} \\ % chktex 29
            \code{GW\_FAR\_BH}   &  105 & \code{TWO\_NIGHTS}             & \code{LENIENT} & \code{3x60L} \\ % chktex 29
            \code{GW\_BURST}     &   52 & \code{NO\_DELAY}               & \code{LENIENT} & \code{3x60L} \\ % chktex 29
            \code{GRB\_SWIFT}    &  207 & \code{TWO\_FIRST\_ONE\_SECOND} & \code{NORMAL}  & \code{3x60L} \\ % chktex 29
            \code{GRB\_FERMI}    &  218 & \code{TWO\_FIRST\_ONE\_SECOND} & \code{NORMAL}  & \code{3x60L} \\ % chktex 29
        \end{tabular}
    \end{center}
    \caption[Event strategy dictionary keys]{
        Event strategy dictionary keys. The ranks are used by the scheduler to sort pointings (see \aref{sec:rank}). The cadence values are matched to \aref{tab:cadence_dict}, constraints values to \aref{tab:constraints_dict} and ExposureSets to \aref{tab:exposuresets_dict}.
    }\label{tab:strategy_dict}
\end{table}

\begin{table}[!p]
    \begin{center}
        \begin{tabular}{lccc}
            Cadence & Max visits & Visit delay (hours) & Valid days \\
            \midrule
            \code{NO\_DELAY}               & 99 &     0 & 3 \\
            \code{TWO\_NIGHTS}             &  2 &    12 & 3 \\
            \code{TWO\_FIRST\_ONE\_SECOND} &  3 & 4, 12 & 3 \\
        \end{tabular}
    \end{center}
    \caption[Cadence strategy dictionary keys]{
        Cadence strategy dictionary keys, used to define pointings in the observation database (see \aref{sec:obsdb}).
    }\label{tab:cadence_dict}
\end{table}

\begin{table}[!p]
    \begin{center}
        \begin{tabular}{lcccc}
            Constraints & Min Alt & Max Sun Alt & Min Moon Separation & Max Moon Phase \\
            \midrule
            \code{NORMAL}  & \SI{30}{\degree} & \SI{-15}{\degree} & \SI{30}{\degree} & Bright \\
            \code{LENIENT} & \SI{30}{\degree} & \SI{-12}{\degree} & \SI{30}{\degree} & Bright \\
        \end{tabular}
    \end{center}
    \caption[Constraints strategy dictionary keys]{
        Constraints strategy dictionary keys, used to define the constraints applied by the scheduler to determine if a pointing is valid (see \aref{sec:constraints}).
    }\label{tab:constraints_dict}
\end{table}

\begin{table}[!p]
    \begin{center}
        \begin{tabular}{lcccc}
            ExposureSets & Set position & Number of exposures & Exposure time & Filter \\
            \midrule
            \code{3x60L}   & 1/1 & 3 & \SI{60}{\second} & \textit{L} \\ % chktex 29
            \code{3x60RGB} & 1/3 & 1 & \SI{60}{\second} & \textit{R} \\ % chktex 29
                           & 2/3 & 1 & \SI{60}{\second} & \textit{G} \\ % chktex 29
                           & 3/3 & 1 & \SI{60}{\second} & \textit{B} \\ % chktex 29
        \end{tabular}
    \end{center}
    \caption[ExposureSets strategy dictionary keys]{
        ExposureSets strategy dictionary keys, used by the pilot when adding exposure sets to the exposure queue (see \aref{sec:exq}).
    }\label{tab:exposuresets_dict}
\end{table}

\clearpage

% ---------
\subsubsection{Event sources}

The first distinction to make is between gravitational-wave and gamma-ray burst events. GOTO's primary aim is searching for GW counterparts, with any GRB follow-up being a useful but decidedly lower-priority use of GOTO's time. Therefore all GW events have ranks considerably higher than GRB events and, due to their importance to the project, GW events also use more lenient observing constraints (defined in \aref{tab:constraints_dict}) than the normal ones used by GRB events and the all-sky survey.

% ---------
\subsubsection{Gravitational-wave sources}

The highest priority for GOTO should always be GW events that are predicted to contain a neutron star component, as they are the ones that are expected to produce an electromagnetic counterpart that GOTO could detect (see \aref{sec:gw_sources}, and the definitions of ``HasNS'' and ``HasRemnant'' in \aref{sec:event_classes}).

Neutron star events (which can include neutron star-black hole binaries and MassGap binaries) have no delay between visits (see \aref{tab:cadence_dict}), meaning once a pointing is completed it will be immediately re-inserted into the queue (for each observation the effective rank will be increased by 10, as described in \aref{sec:rank}). For these events, once GOTO has observed all of the visible tiles once it will immediately start covering the skymap again, and by default this will continue until it reaches the stop time three days after the event (or until it reaches 99 observations of each tile, which is just inserted as a nominal maximum and is not expected to be reached within three nights).

Binary black hole (BBH) events, on the other hand, have a more limited \code{TWO\_NIGHTS} strategy, which only requires two observations of each tile with at least 12 hours between them. The 12 hour delay in practice means observing on two subsequent nights; as the GOTO site on La Palma can not see the northern celestial pole circumpolar targets do not need to be considered, and even in winter the longest nights are less than 12 hours.

\newpage

For both classes of events it is expected that GOTO will want to respond immediately and attempt to image the localisation area as quickly as possible. The sole current detection of an electromagnetic counterpart to a gravitational-wave event, AT~2017gfo associated with GW170817 (see \aref{sec:followup}), was first observed by Swope 10.9 hours after the event, and there remains a lot of uncertainty in how kilonova appear in their early stages \citep{GW_kilonova_early}. Therefore even an early non-detection by GOTO would provide valuable information to constrain the lightcurve.

% ---------
\subsubsection{Gravitational-wave distances}

For both neutron star and black hole events a distinction is also made between ``close'' and ``far'' events based on their reported source distance: a close neutron star event is defined to be within \SI{400}{\mega\parsec} while a close binary black hole event is within \SI{100}{\mega\parsec}.

Swope observed AT~2017gfo at \textit{i}$=17.057\pm0.018$ mag \citep{GW170817_Swope}, which at a distance of \SI{40}{\mega\parsec} corresponds to an absolute magnitude of -16. Using the equation for apparent magnitude
%
\begin{equation}
    m-M = -5 +5\log_{10}(d),
    \label{eq:absolute_magnitude}
\end{equation}
%
AT~2017gfo would have peaked above 19th magnitude out to a distance of \SI{100}{\mega\parsec} and above 22nd magnitude out to a distance of \SI{400}{\mega\parsec}. Binary-black hole mergers are not expected to produce the same amounts of ejected matter that would produce a kilonova, but some predictions suggest there may be material ejected from disks around one or more of the black holes which might reach 22nd magnitude if closer than \SI{100}{\mega\parsec} \citep{BBH_EM}. As a first approximation, therefore, the 22nd magnitude limits were adopted for the close/far distinction. Note this is a arbitrary division, not particularly based on GOTO's capability but a more general division into sources that could have a counterpart discoverable by existing wide-field follow-up projects (see the limiting magnitudes in \aref{tab:rivals} in \aref{sec:goto_motivation}).

\newpage

The only difference in strategy between ``close'' and ``far'' events is that they are assigned different initial ranks when inserted into the database (shown in \aref{tab:strategy_dict}). The rest of the strategy values, including cadence and constraints, are identical, and therefore the division is completely academic except in the case where \emph{multiple} events exist in the observing queue at the same time. Should this happen, and tiles for both events are visible at the same time, then the ranking system provides a quick method to prioritise events for observations. Using the ranks given in \aref{tab:strategy_dict}, events from close neutron star mergers would be inserted at rank 2, while far mergers of the same type would be inserted at rank 13. As the rank of a pointing is increased by 10 every time it is observed (see \aref{sec:rank}), this would prioritise two passes of the ``close'' skymap before the ``far'' skymap. The first observation would be at rank 2, the second at rank 12, and by the third it would be in the queue at rank 22. This is lower than the initial rank of 13 for the ``far'' event, so the latter would then be higher in the queue. Any following observations would alternate between the two events: ``close'' observation 3 at rank 22, ``far'' observation 2 at rank 23, ``close'' observation 4 at rank 32 etc. The ranks for the other events are likewise carefully chosen: close BBH events would be inserted at rank 24 and therefore fall behind the first three passes of a close NS or two passes of a far NS.\@ Far BBH events are very unlikely to produce any visible optical counterparts, so although GOTO will still follow-up the alerts they are inserted at rank 105, well below several passes of any more promising GW events.

What is currently not considered by the strategy outlined above is a \textit{maximum} valid distance, beyond which GOTO would not respond to the alert. LVC detections have already reached out to the gigaparsec scale, and at those distances the chance of there being any optical counterpart visible from Earth is very low. At the time of writing GW events are rare enough that there is little reason for GOTO not to follow up every alert, but in the future if necessary it would be easy to limit which events GOTO follows up based on distance (or another parameter, such as the false-alarm rate).

\newpage

% ---------
\subsubsection{Gravitational-wave burst alerts}

Gravitational-wave events from the LVC burst pipelines \citep{GW_burst} are hard to categorise, as there is very little information to base any observation strategy on (as noted in \aref{sec:event_classes}, alerts from unmodelled burst detections do not contain source classifications or predicted distances). As a compromise they use the same cadence strategy as neutron star events, but are inserted at rank 52, below any more promising GW events but above binary-black hole events. As described in \aref{sec:gw_sources}, to date no burst alerts, e.g.\ from supernovae, have been released by the LVC.\@ The only detections from the burst pipelines (that have been made public) have corresponded to compact binary coalescence events detected by the other pipelines.

% ---------
\subsubsection{Gamma-ray burst alerts}

Gamma-ray burst alerts from \textit{Fermi} and \textit{Swift} are also processed by the sentinel and inserted into the observation database. As shown in \aref{tab:strategy_dict}, pointings from GRB events are inserted at ranks above 200, ensuring that GOTO will always prioritise gravitational-wave follow-up. GRB events use a different cadence strategy of \code{TWO\_FIRST\_ONE\_SECOND}, which, as detailed in \aref{tab:cadence_dict}, consists of three observations: two in the first night separated by at least 4 hours and another on the second night. This cadence was recently implemented to attempt to account for the fast-fading nature of GRB afterglows, and is an example of more complex cadences allowed by the G-TeCS scheduler.

For gamma-ray burst events the only distinction is made between events originating from \textit{Swift} and \textit{Fermi}. Typically \textit{Swift}'s \acro{bat} detections are much better localised than those from \textit{Fermi}'s \acro{gbm}, and so, in cases where a source is detected by both, the \textit{Swift} detection should be prioritised. Further division could be made based on the burst being classified by \textit{Fermi} as Long or Short, but this is not currently implemented.

% ---------
\subsubsection{Exposure sets}

Each strategy currently defined in \aref{tab:strategy_dict} uses the same exposure set definition: \code{3x60L}. From \aref{tab:exposuresets_dict} this comprises of three sequential \SI{60}{\second} exposures in the \textit{L} filter, the same as the all-sky survey. A different set of exposures using the coloured filters instead is shown in \aref{tab:exposuresets_dict} as \code{3x60RGB}, this a possible example of what could be defined using the G-TeCS system but is not used as part of any current strategy.  % chktex 29

% ---------
\subsubsection{Subsiquent strategy alterations}

The strategies detailed in the above sections are designed to inform the default, automatic reaction of GOTO to any incoming alert. They are not alone intended to be a perfect reaction for every case, and later, human-guided input is to be expected. For example, the default strategy for a gravitational-wave alert from a close neutron star source is to observe the tiles inserted over and over until the three day limit has passed. In practice, it should be clear after the first few passes if there is any counterpart candidate, in which case a human could intervene and direct GOTO to go take observations of particular tiles with promising candidates. Likewise, if after the first pass of a distant binary black hole event skymap no candidates are detected, and nothing has been reported from other facilities, the decision could be made not to bother with the second pass the day after and just return to the all-sky survey.

Another possible modification to a follow-up campaign could be the inclusion of feedback from the GOTOphoto detection pipeline (described in \aref{sec:gotophoto}). In the same way as a human could take over observations described above, should the pipeline detect a promising source it could be allowed to trigger GOTO to re-observe that tile, either automatically or after human vetting. This would require significant development to the pipeline and sentinel which is not a current priority, and is given as an example of possible future work in \aref{sec:software_future}.

\newpage

\end{colsection}

% ~~~~~~~~~~~~~~~~~~~~

\subsection{Inserting events into the observation database}
\label{sec:event_insert}
\begin{colsection}

Once the strategy has been determined for an event, based on the details described in \aref{sec:event_strategy}, then the sentinel needs to insert pointings into the observation database so they are visible to the scheduler (see \aref{sec:obsdb} and \aref{sec:scheduler}). This involves mapping the event skymap on to the all-sky grid, as well as accounting for any previous detections of the same event.

% ---------
\subsubsection{Previous records}

Before inserting any new pointings, the sentinel event handler first checks for any existing records of the new event in the observation database \code{events} table. This is done to update event pointings as revised VOEvent alerts are received, or in order to process retraction events. As described in \aref{sec:event_classes} there are several types of LVC alerts: ``Preliminary'' alerts are released first, followed by ``Initial'' alerts when the detections are confirmed, updated notices are released as ``Update'' alerts, and ``Retraction'' alerts are issued if the detection is later retracted. At any of these stages the event skymap might be modified, shifting the area to observe, and the pointings in the observation database will therefore need to updated. This is most common for gravitational-wave events as the initial skymaps are typically created using the rapid BAYESTAR pipeline \citep{BAYESTAR}, while later updated skymaps are made using using the slower LALInference code \citep{LALInference}. If a previous entry for a new event is detected then all of the old pointings that are still pending in the queue are deleted, before the new ones are added as described below. Should the event be of type \code{GWRetractionEvent} then this is where the event handler exits, as once the previous pointings are deleted then there are no more to replace them.

% ---------
\subsubsection{Mapping onto the all-sky grid}

Once any existing pointings have been removed, new entries in the database need to be created. All GOTO pointings from the sentinel are defined \textit{on-grid}, meaning that they need to be mapped onto the current GOTO-tile sky grid (see \aref{sec:gototile}). The database \code{grids} table contains the field of view and overlap parameters of the current grid as well as the algorithm used (see \aref{sec:algorithms}), allowing it to be reconstructed using GOTO-tile within the event handler. Once a GOTO-tile \code{SkyGrid} class has been created, then a corresponding \code{SkyMap} class is made based on the information in the event. If the event was from a gravitational-wave alert then it should have a URL to download the LVC-created skymap (shown in \aref{fig:voevent_xml}). If instead it just has a coordinate and error radius, i.e.\ it is a GRB alert, then a new Gaussian skymap is constructed as described in \aref{sec:grb_skymaps}. Once both grid and map are ready then the skymap is mapped onto the grid as described in \aref{sec:mapping_skymaps}, using the class method \code{SkyGrid.apply\_skymap(SkyMap)}. This returns a table of tiles and associated contained probabilities, which are used to create the database pointings. %chktex 36

% ---------
\subsubsection{Selecting tiles}

The tile probability table created by GOTO-tile contains entries for every one of the thousands of tiles in the all-sky grid, of which the vast majority will contain only a very small amount of the overall probability for any reasonably-well located skymap. Adding an entry to the database for every tile would therefore be unnecessary, and even harmful to the follow-up observations. The scheduling system is designed to complete a full pass of the visible tiles before going on to re-observe those already completed, a consequence of the effective rank increasing by 10 each time a tile is observed (see \aref{sec:rank}), and so adding excess tiles would delay subsequent observations. On the other hand, it is still important to add in enough tiles covering enough of the probability area to maximise the chance of detecting the source. Therefore there is a balance required between adding too many or too few tiles into the database.

There are multiple ways to chose which tiles to select. Initially GOTO-alert used a simple cut-off in terms of each tile's contained probability, selecting tiles that contain greater than, for example, $1\%$ of the total probability. This hard limit however quickly proved to be unsuitable, as large, spread-out skymaps might have few if any tiles which reach the limit, while for well-localised events adding tiles down to the $1\%$ level is redundant and would waste time observing them compared to revisiting higher probability tiles. An attempt to correct this was to modify the probability cut-off for each skymap, making it a function of the highest tile probability. For example, a well-localised event (such as GW170817, see \aref{fig:170817_gw}) might result in the highest-probability tile containing $40\%$ of the probability; with a $P=0.1P_\text{max}$ cut-off all tiles containing 4\% or above would therefore be added to the database. On the other, hand a spread-out skymap might have a highest tile containing only 2\% of the probability, so then all tiles with 0.2\% or above would be added. Ultimately, a hard probability cut-off proved to be unresponsive to the spread of the skymap, and determining the relative limit (e.g. 0.1 in the above example) was hard to balance between large and small maps. The preferred method to select tiles is instead based on the 90\% probability contour, this method was discussed previously in \aref{sec:mapping_skymaps}.

% ---------
\subsubsection{Adding database entries}

Once the tiles to add have been selected then entries can be inserted into the appropriate tables in the observation database (see \aref{sec:obsdb}).

First a new entry in the \code{events} table is added for the event, containing the unique VOEvent IVORN, the event source (LVC, \textit{Fermi} etc), type (GW or GRB), and an event ID (for example S190425z for an LVC event, \textit{Fermi} and \textit{Swift} have their own trigger IDs). Then an entry in the \code{surveys} table is also created, in order to group together all of the pointings from this particular event. The database does allow multiple surveys per event; for example, there could be a quick initial survey in a wide-passband filter that prioritises possible host galaxies, followed by a slower survey using the colour filters and longer exposure times that focuses on covering the skymap. However, at the time of writing each event only has a single survey defined.

Finally, the individual tiles are inserted as entries in the \code{mpointings} table. The most important entries for the mpointings are determined by the event strategy as described in \aref{sec:event_strategy}: the rank (taken from \aref{tab:strategy_dict}), cadence parameters (from \aref{tab:cadence_dict}), the target constraint values (minimum altitude, moon phase etc; from \aref{tab:constraints_dict}), and the exposure settings (exposure time, filter and number in each set; from \aref{tab:exposuresets_dict}). Each mpointing is connected to an entry in the \code{grid\_tiles} table for this particular grid, and the tile probabilities are stored as corresponding weights in the \code{survey\_tiles} table. Once the mpointings are defined, the first pointings are also created and added to the \code{pointings} table with the status \code{pending}, to insure they are immediately valid in the queue (see \aref{sec:scheduler}).

Once all of the entries described above have been added to the observation database the event has been successfully handled. At this point the GOTO-alert event handler sends the final visibility report to Slack (see \aref{sec:event_slack}) and exits. In total the entire event handling process, from the alert being received to the pointings being added to the database, takes under 10 seconds. The majority of this time for a gravitational-wave event is downloading the often quite large skymap files from GraceDB, and actually processing the event only takes a few seconds. Once the event pointings are added to the database they should be ready to observe the next time the scheduler fetches the queue, and if they are valid the highest priority pointing will be sent to the pilot to immediately begin follow-up observations.

\end{colsection}

% ########################################

\section{Summary and Conclusions}
\label{sec:alerts_conclusion}

% ~~~~~~~~~~~~~~~~~~~~

\begin{colsection}

In this chapter I described how the functions within the GOTO-alert process astronomical transient event alerts.

The GOTO sentinel alert listener receives gravitational-wave alerts from the LIGO-Virgo Collaboration in the form of GCN Circulars, which are formatted XML documents following the VOEvent schema. These VOEvents contain the key properties of the detection and a link to a skymap localisation file, which is then mapped onto the GOTO all-sky grid (see \aref{chap:tiling}).

One of the important features of the GOTO-alert event handler is the ability to automatically select the observation strategy for different alerts based on the contents of the VOEvent. Gravitational-wave detections predicted to come from near-by binary neutron star or neutron star-black hole binaries are the highest priority to follow up, followed by other classes of events. Gamma-ray burst events are also processed and added to the observations database by the G-TeCS sentinel (see \aref{chap:autonomous}), but always at a lower priority than the gravitational-wave alerts.

At the time of writing GOTO has been following-up gravitational-wave events for several months since the start of the third LIGO-Virgo observing run. The results of the observing run so far are detailed as part of the overall conclusions in \aref{chap:conclusion}.

\end{colsection}

% ########################################
